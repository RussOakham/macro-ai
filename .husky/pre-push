#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Comprehensive security scanning for pre-push (thorough checks)
echo "🛡️  Running comprehensive security scans before push..."

# Check if any workflow files are being pushed
if git diff --name-only origin/$(git rev-parse --abbrev-ref HEAD)..HEAD | grep -q '\.github/workflows/.*\.ya\?ml$'; then
  echo "📋 GitHub Actions workflow files detected in push, running comprehensive security scans..."
  
  # Run basic security scan first (faster)
  echo "🔍 Running basic security scan..."
  pnpm security:scan
  
  if [ $? -ne 0 ]; then
    echo "❌ Basic security scan failed. Please fix the issues before pushing."
    echo "💡 Tip: Run 'pnpm security:scan' locally to see detailed results."
    exit 1
  fi
  
  # Run advanced security scan for comprehensive analysis
  echo "🔍 Running advanced security scan..."
  pnpm security:scan:advanced
  
  if [ $? -ne 0 ]; then
    echo "❌ Advanced security scan failed. Please fix the issues before pushing."
    echo "💡 Tip: Run 'pnpm security:scan:advanced' locally to see detailed results."
    exit 1
  fi
  
  # Run CodeQL scan for deep security analysis (most comprehensive)
  echo "🔍 Running CodeQL security scan..."
  pnpm security:scan:codeql
  
  if [ $? -ne 0 ]; then
    echo "❌ CodeQL security scan failed. Please fix the issues before pushing."
    echo "💡 Tip: Run 'pnpm security:scan:codeql' locally to see detailed results."
    exit 1
  fi
  
  echo "✅ All comprehensive security scans passed!"
  echo "🚀 Your workflows are secure and ready to push!"
else
  echo "ℹ️  No GitHub Actions workflow files in this push, skipping security scans."
fi