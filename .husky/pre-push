#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Modern security scanning for pre-push using Snyk and ESLint
echo "ğŸ›¡ï¸  Running modern security scans before push..."

# Check if any workflow files are being pushed
if git diff --name-only origin/$(git rev-parse --abbrev-ref HEAD)..HEAD | grep -q '\.github/workflows/.*\.ya\?ml$'; then
  echo "ğŸ“‹ GitHub Actions workflow files detected in push, running security scans..."
  
  # Run Snyk security scan (dependency + code vulnerabilities)
  echo "ğŸ” Running Snyk security scan..."
  pnpm security:scan
  
  if [ $? -ne 0 ]; then
    echo "âŒ Snyk security scan failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan' locally to see detailed results."
    exit 1
  fi
  
  # Run workflow validation with actionlint
  echo "ğŸ” Running GitHub Actions workflow validation..."
  pnpm security:scan:workflows
  
  if [ $? -ne 0 ]; then
    echo "âŒ Workflow validation failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan:workflows' locally to see detailed results."
    exit 1
  fi
  
  echo "âœ… All security scans passed!"
  echo "ğŸš€ Your workflows are secure and ready to push!"
else
  echo "â„¹ï¸  No GitHub Actions workflow files in this push, running basic security scan..."
  
  # Run basic Snyk scan for dependency vulnerabilities
  echo "ğŸ” Running dependency security scan..."
  pnpm security:scan:deps
  
  if [ $? -ne 0 ]; then
    echo "âŒ Dependency security scan failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan:deps' locally to see detailed results."
    exit 1
  fi
  
  echo "âœ… Basic security scan passed!"
fi