#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Comprehensive security scanning for pre-push (thorough checks)
echo "ğŸ›¡ï¸  Running comprehensive security scans before push..."

# Check if any workflow files are being pushed
if git diff --name-only origin/$(git rev-parse --abbrev-ref HEAD)..HEAD | grep -q '\.github/workflows/.*\.ya\?ml$'; then
  echo "ğŸ“‹ GitHub Actions workflow files detected in push, running comprehensive security scans..."
  
  # Run basic security scan first (faster)
  echo "ğŸ” Running basic security scan..."
  pnpm security:scan
  
  if [ $? -ne 0 ]; then
    echo "âŒ Basic security scan failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan' locally to see detailed results."
    exit 1
  fi
  
  # Run advanced security scan for comprehensive analysis
  echo "ğŸ” Running advanced security scan..."
  pnpm security:scan:advanced
  
  if [ $? -ne 0 ]; then
    echo "âŒ Advanced security scan failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan:advanced' locally to see detailed results."
    exit 1
  fi
  
  # Run CodeQL scan for deep security analysis (most comprehensive)
  echo "ğŸ” Running CodeQL security scan..."
  pnpm security:scan:codeql
  
  if [ $? -ne 0 ]; then
    echo "âŒ CodeQL security scan failed. Please fix the issues before pushing."
    echo "ğŸ’¡ Tip: Run 'pnpm security:scan:codeql' locally to see detailed results."
    exit 1
  fi
  
  echo "âœ… All comprehensive security scans passed!"
  echo "ğŸš€ Your workflows are secure and ready to push!"
else
  echo "â„¹ï¸  No GitHub Actions workflow files in this push, skipping security scans."
fi