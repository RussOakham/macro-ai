---
name: Deploy PR Preview (Pulumi)

on:
  pull_request:
    types: [ opened, synchronize, closed ]
    branches:
    - main
    - develop

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  deploy-pr-preview:
    name: Deploy PR Preview Infrastructure
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    outputs:
      api-endpoint: ${{ steps.deploy.outputs.api-endpoint }}
      stack-name: ${{ steps.deploy.outputs.stack-name }}
      should-deploy: ${{ steps.decide-deploy.outputs.should-deploy }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '10.14.0'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.4'

    - name: Cache pnpm dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pnpm-store
          node_modules
        key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          pnpm-${{ runner.os }}-

    - name: Install Pulumi CLI
      run: |
        curl -fsSL https://get.pulumi.com | sh
        echo "$HOME/.pulumi/bin" >> "$GITHUB_PATH"

    - name: Build and push Docker image
      if: github.event.action != 'closed'
      id: build-image
      env:
        AWS_REGION: us-east-1
        DOCKER_BUILDKIT: 1
      run: |
        # Build Docker image for PR
        IMAGE_TAG="pr-${{ github.event.number }}-${{ github.run_id }}"

        # Build and push to ECR
        cd apps/express-api
        docker build \
          --build-arg NODE_ENV=production \
          --build-arg SERVER_PORT=3040 \
          --build-arg APP_ENV=pr-${{ github.event.number }} \
          --target production \
          -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/macro-ai-staging-express-api:${IMAGE_TAG} \
          .

        # Login to ECR and push
        aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
        docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/macro-ai-staging-express-api:${IMAGE_TAG}

        echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "‚úÖ Docker image built and pushed: ${IMAGE_TAG}"

    - name: Decide deployment action
      id: decide-deploy
      run: |
        if [[ "${{ github.event.action }}" == "closed" ]]; then
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "deployment-action=destroy" >> $GITHUB_OUTPUT
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "deployment-action=deploy" >> $GITHUB_OUTPUT
        fi

    - name: Deploy PR Preview Infrastructure
      if: steps.decide-deploy.outputs.should-deploy == 'true'
      id: deploy
      run: |
        echo "üöÄ Starting PR Preview deployment..."
        echo "Environment: pr-${{ github.event.number }}"
        echo "PR Number: ${{ github.event.number }}"
        echo "Branch: ${{ github.head_ref }}"
        echo "Image Tag: ${{ steps.build-image.outputs.image-tag }}"

        # Call the reusable workflow via GitHub API or use a different approach
        # For now, we'll use the Pulumi CLI directly
        cd infrastructure/pulumi

        # Set up environment variables
        export PULUMI_ACCESS_TOKEN="${{ secrets.PULUMI_ACCESS_TOKEN }}"
        export DOPPLER_TOKEN="${{ secrets.DOPPLER_TOKEN_DEV }}"
        export AWS_REGION="us-east-1"
        export AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"

        STACK_NAME="pr-${{ github.event.number }}"
        IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/macro-ai-staging-express-api:${{ steps.build-image.outputs.image-tag }}"

        echo "üîß Setting Pulumi configuration for stack: ${STACK_NAME}"
        pulumi stack select ${STACK_NAME} || pulumi stack init ${STACK_NAME}

        # Set all required configuration
        pulumi config set environmentName "pr-${{ github.event.number }}" --stack "${STACK_NAME}"
        pulumi config set deploymentType "preview" --stack "${STACK_NAME}"
        pulumi config set imageUri "${IMAGE_URI}" --stack "${STACK_NAME}"
        pulumi config set imageTag "${{ steps.build-image.outputs.image-tag }}" --stack "${STACK_NAME}"
        pulumi config set doppler:dopplerToken "${DOPPLER_TOKEN}" --secret --stack "${STACK_NAME}"
        pulumi config set prNumber "${{ github.event.number }}" --stack "${STACK_NAME}"
        pulumi config set branchName "${{ github.head_ref }}" --stack "${STACK_NAME}"
        pulumi config set customDomainName "macro-ai.russoakham.dev" --stack "${STACK_NAME}"
        pulumi config set hostedZoneId "${{ secrets.ROUTE53_HOSTED_ZONE_ID }}" --stack "${STACK_NAME}"

        echo "üöÄ Deploying infrastructure..."
        pulumi up --yes --stack "${STACK_NAME}"

        # Get outputs
        API_ENDPOINT=$(pulumi stack output apiEndpoint --stack "${STACK_NAME}")
        STACK_NAME_OUTPUT=$(pulumi stack output stackName --stack "${STACK_NAME}" || echo "${STACK_NAME}")

        echo "api-endpoint=${API_ENDPOINT}" >> $GITHUB_OUTPUT
        echo "stack-name=${STACK_NAME_OUTPUT}" >> $GITHUB_OUTPUT

        echo "‚úÖ Deployment completed successfully!"
        echo "üåê API Endpoint: ${API_ENDPOINT}"

    - name: Health Check
      if: steps.decide-deploy.outputs.deployment-action == 'deploy' && steps.deploy.outputs.api-endpoint
      id: health-check
      run: |
        API_ENDPOINT="${{ steps.deploy.outputs.api-endpoint }}"
        echo "üîç Performing health check on: '${API_ENDPOINT}'"

        # Wait for the service to be ready
        sleep 30

        # Perform health check
        for i in {1..10}; do
          if curl -f -s "${API_ENDPOINT}/health" > /dev/null 2>&1; then
            echo "‚úÖ Health check passed on attempt ${i}"
            echo "health-status=healthy" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Service is responding at ${API_ENDPOINT}"
            exit 0
          fi
          echo "‚è≥ Health check attempt ${i} failed, retrying..."
          sleep 15
        done

        echo "‚ùå Health check failed after 10 attempts"
        echo "health-status=unhealthy" >> "$GITHUB_OUTPUT"
        exit 1

    - name: Comment PR with deployment info
      if: steps.decide-deploy.outputs.deployment-action == 'deploy' && steps.deploy.outputs.api-endpoint
      uses: actions/github-script@v7
      with:
        script: |
          const apiEndpoint = '${{ steps.deploy.outputs.api-endpoint }}';
          const stackName = '${{ steps.deploy.outputs.stack-name }}';
          const healthStatus = '${{ steps.health-check.outputs.health-status }}';
          const prNumber = '${{ github.event.number }}';
          const branchRef = '${{ github.head_ref }}';

          let healthIcon = '‚ö†Ô∏è';
          let healthMessage = 'Health check in progress...';

          if (healthStatus === 'healthy') {
            healthIcon = '‚úÖ';
            healthMessage = 'Health check passed - service is ready!';
          } else if (healthStatus === 'unhealthy') {
            healthIcon = '‚ùå';
            healthMessage = 'Health check failed - please check the workflow logs';
          }

          const body = [
            '## üöÄ PR Preview Environment Deployed',
            '',
            `**${healthIcon} Infrastructure deployed successfully!**`,
            '',
            `- **API Endpoint**: ${apiEndpoint}`,
            `- **Pulumi Stack**: \`${stackName}\``,
            `- **Environment**: Preview for PR #${prNumber}`,
            `- **Branch**: \`${branchRef}\``,
            `- **Health Status**: ${healthMessage}`,
            '',
            '### üîç Testing Your Changes',
            '',
            'You can now test your changes at the API endpoint above. The environment includes:',
            '- Full ECS Fargate deployment',
            '- Application Load Balancer',
            '- Custom domain (\`pr-' + prNumber + '.api.macro-ai.russoakham.dev\`)',
            '- Doppler secrets integration',
            '- Health check endpoint: \`' + apiEndpoint + '/health\`',
            '',
            '### üßπ Automatic Cleanup',
            '',
            'This environment will be automatically destroyed when you:',
            '- Close this PR',
            '- Merge this PR to main',
            '- Push new commits (environment will be updated)',
            '',
            '**‚ö†Ô∏è Note**: This is a cost-optimized preview environment with reduced resources.'
          ].join('\n');

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Comment PR on failure
      if: steps.decide-deploy.outputs.deployment-action == 'deploy' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = '${{ github.event.number }}';

          const body = [
            '## ‚ùå PR Preview Environment Deployment Failed',
            '',
            '**‚ùå The preview environment could not be deployed.**',
            '',
            'Please check the workflow logs for details. Common issues:',
            '- Docker build failures',
            '- Pulumi deployment errors',
            '- AWS permission issues',
            '- Doppler configuration problems',
            '',
            'The development team has been notified.'
          ].join('\n');

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Cleanup on PR close
      if: github.event.action == 'closed'
      id: cleanup
      run: |
        echo "üßπ Cleaning up PR #${{ github.event.number }} environment..."

        # For now, manual cleanup since we're not using Pulumi Review Stacks yet
        # This will be replaced when we configure Review Stacks
        STACK_NAME="pr-${{ github.event.number }}"

        if pulumi stack select ${STACK_NAME} 2>/dev/null; then
          echo "üîç Found stack ${STACK_NAME}, destroying..."
          pulumi destroy --yes --stack "${STACK_NAME}"
          pulumi stack rm ${STACK_NAME} --yes
          echo "‚úÖ Stack ${STACK_NAME} destroyed and removed"
        else
          echo "‚ÑπÔ∏è Stack ${STACK_NAME} not found or already cleaned up"
        fi

        echo "cleanup-status=completed" >> $GITHUB_OUTPUT

    - name: Comment PR on cleanup
      if: github.event.action == 'closed'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = '${{ github.event.number }}';

          const body = [
            '## üßπ PR Preview Environment Cleaned Up',
            '',
            '**‚úÖ The preview environment for PR #' + prNumber + ' has been destroyed.**',
            '',
            'The following resources have been cleaned up:',
            '- ECS Fargate service and task definition',
            '- Application Load Balancer and target group',
            '- VPC resources (if not shared)',
            '- CloudWatch log groups',
            '- Route53 records (if applicable)',
            '',
            '**Cost savings**: All preview environment resources have been removed to avoid unnecessary charges.'
          ].join('\n');

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
