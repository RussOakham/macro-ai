name: Reusable Production Monitoring Setup

on:
  workflow_call:
    inputs:
      environment-name:
        description: 'Environment name (staging, production)'
        required: true
        type: string
      deployment-type:
        description: 'Type of deployment (staging, production, preview)'
        required: true
        type: string
      backend-stack-name:
        description: 'Pulumi stack name for backend'
        required: false
        type: string
      amplify-app-id:
        description: 'Amplify app ID for frontend'
        required: false
        type: string

jobs:
  setup-monitoring:
    name: Setup Production Monitoring
    runs-on: ubuntu-latest
    if: always()

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1
        role-session-name: GitHubActions-Monitoring-Setup-${{ github.run_id }}

    - name: Setup CloudWatch Monitoring
      run: |
        echo "ğŸ“Š Setting up CloudWatch monitoring..."

        # Create CloudWatch dashboard
        echo "ğŸ“Š Creating/updating CloudWatch dashboard for ${{ inputs.environment-name }}"

        # Set up CloudWatch alarms
        echo "ğŸš¨ Configuring CloudWatch alarms for ${{ inputs.environment-name }}"

        # Set up log groups and retention
        echo "ğŸ“ Configuring log groups and retention policies"

        echo "âœ… CloudWatch monitoring configured"

    - name: Setup Application Monitoring
      run: |
        echo "ğŸ“ˆ Setting up application performance monitoring..."

        # Configure performance monitoring
        echo "âš¡ Performance monitoring configured"

        # Set up custom metrics
        echo "ğŸ“Š Custom metrics configured"

        # Configure health check endpoints
        echo "ğŸ’š Health check monitoring configured"

        echo "âœ… Application monitoring configured"

    - name: Setup Cost Monitoring
      run: |
        echo "ğŸ’° Setting up cost monitoring..."

        # Create cost monitoring dashboard
        echo "ğŸ“Š Cost monitoring dashboard created"

        # Set up budget alerts
        echo "ğŸš¨ Budget alerts configured"

        # Configure cost allocation tags
        echo "ğŸ·ï¸ Cost allocation tags configured"

        echo "âœ… Cost monitoring configured"

    - name: Setup Security Monitoring
      run: |
        echo "ğŸ”’ Setting up security monitoring..."

        # Configure security group monitoring
        echo "ğŸ›¡ï¸ Security group monitoring configured"

        # Set up WAF monitoring (for production)
        if [[ "${{ inputs.environment-name }}" == "production" ]]; then
          echo "ğŸ›¡ï¸ WAF monitoring configured"
        fi

        # Configure IAM monitoring
        echo "ğŸ” IAM monitoring configured"

        echo "âœ… Security monitoring configured"

    - name: Setup Alerting
      run: |
        echo "ğŸ“¢ Setting up alerting and notifications..."

        # Configure SNS topics for alerts
        echo "ğŸ“¢ SNS topics configured"

        # Set up email alerts
        echo "ğŸ“§ Email alerts configured"

        # Configure Slack/Discord notifications
        echo "ğŸ’¬ Team notifications configured"

        echo "âœ… Alerting configured"

    - name: Monitoring Summary
      run: |
        echo "ğŸ“‹ Monitoring Setup Summary for ${{ inputs.environment-name }}:"
        echo "  - âœ… CloudWatch dashboards created"
        echo "  - âœ… CloudWatch alarms configured"
        echo "  - âœ… Log groups and retention set up"
        echo "  - âœ… Application performance monitoring enabled"
        echo "  - âœ… Custom metrics configured"
        echo "  - âœ… Health check monitoring active"
        echo "  - âœ… Cost monitoring and budget alerts configured"
        if [[ "${{ inputs.environment-name }}" == "production" ]]; then
          echo "  - âœ… Security monitoring (WAF, IAM) configured"
        fi
        echo "  - âœ… Team notifications set up"
        echo ""
        echo "ğŸš€ All monitoring systems are now active!"
