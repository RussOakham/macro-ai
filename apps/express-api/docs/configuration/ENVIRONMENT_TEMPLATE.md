# Environment Configuration Guide

This guide consolidates all environment configuration for the Macro AI Express API into a single, comprehensive reference.

## Quick Start

1. **Local Development**: Copy `env.local.example` to `.env.local`
2. **Preview Deployments**: Use `env.build.preview.example` for build-time values
3. **Production**: Environment variables are managed by the deployment system

## Consolidated Environment Variables

### Core Configuration

```bash
# Environment Type
NODE_ENV=development                    # development | production | test
APP_ENV=development                     # development | staging | production | pr-123
SERVER_PORT=3040                        # Port for the Express server
```

### API Security

```bash
# API Key (minimum 32 characters)
API_KEY=your-api-key-here-minimum-32-characters-long

# Cookie Encryption Key (minimum 32 characters)
COOKIE_ENCRYPTION_KEY=your-cookie-encryption-key-here-minimum-32-characters-long
```

### AWS Cognito

```bash
AWS_COGNITO_REGION=us-east-1
AWS_COGNITO_USER_POOL_ID=your-user-pool-id
AWS_COGNITO_USER_POOL_CLIENT_ID=your-client-id
AWS_COGNITO_USER_POOL_SECRET_KEY=your-secret-key
AWS_COGNITO_REFRESH_TOKEN_EXPIRY=30
```

### Database Configuration

```bash
# PostgreSQL Connection String
RELATIONAL_DATABASE_URL=postgresql://user:password@localhost:5432/macro_ai_dev

# Redis Connection String
REDIS_URL=redis://localhost:6379
```

### AI Service Configuration

```bash
# OpenAI API Key
OPENAI_API_KEY=sk-your-openai-api-key-here
```

### Rate Limiting

#### General Rate Limiting

```bash
RATE_LIMIT_WINDOW_MS=900000            # 15 minutes in milliseconds
RATE_LIMIT_MAX_REQUESTS=100            # Max requests per window
```

#### Authentication Rate Limiting

```bash
AUTH_RATE_LIMIT_WINDOW_MS=3600000      # 1 hour in milliseconds
AUTH_RATE_LIMIT_MAX_REQUESTS=10        # Max auth requests per hour
```

#### API Rate Limiting

```bash
API_RATE_LIMIT_WINDOW_MS=60000         # 1 minute in milliseconds
API_RATE_LIMIT_MAX_REQUESTS=60         # Max API requests per minute
```

### CORS & Security

```bash
# CORS Allowed Origins (comma-separated)
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001

# Cookie Domain
COOKIE_DOMAIN=localhost                 # localhost for development
```

### Logging

```bash
# Log Level (optional)
LOG_LEVEL=info                          # debug | info | warn | error
```

## Environment-Specific Configurations

### Local Development

- **File**: `.env.local` (copy from `env.local.example`)
- **Rate Limiting**: More permissive (1000 requests, 50 auth, 600 API)
- **CORS**: `http://localhost:3000,http://localhost:3001`
- **Database**: Local PostgreSQL and Redis instances

### Preview Deployments

- **Build-time**: `env.build.preview.example` ‚Üí `.env.build.preview`
- **Runtime**: `env.runtime.preview.example` ‚Üí `.env.runtime.preview` (auto-generated by CDK)
- **Rate Limiting**: Production-like (100 requests, 10 auth, 60 API)
- **CORS**: Dynamic based on PR number and domain

### Production

- **Configuration**: Managed by deployment system
- **Rate Limiting**: Strict production limits
- **CORS**: Restricted to production domains
- **No .env files**: All values injected at runtime

## Rate Limiting Variations

| Environment            | General    | Auth    | API        |
| ---------------------- | ---------- | ------- | ---------- |
| **Local Development**  | 1000/15min | 50/hour | 600/minute |
| **Preview/Production** | 100/15min  | 10/hour | 60/minute  |

## File Consolidation Benefits

1. **Single Source of Truth**: All environment variables documented in one place
2. **Easier Maintenance**: Update one file instead of three
3. **Clearer Documentation**: Better understanding of what each variable does
4. **Reduced Duplication**: No more copying values between files
5. **Better Onboarding**: New developers have one comprehensive reference

## Migration Notes

- **env.local.example**: Keep for backward compatibility
- **env.build.preview.example**: Keep for CDK build process
- **env.runtime.preview.example**: Keep for CDK runtime process
- **New**: This consolidated guide serves as the primary reference

## Next Steps

1. ‚úÖ **Phase 2A Complete**: Console log cleanup with Pino logger
2. üîÑ **Phase 2B In Progress**: Environment file consolidation
3. ‚è≥ **Phase 2C**: Deprecated scripts verification

## Recommendations

1. **Use this guide** as the primary reference for environment configuration
2. **Keep existing example files** for backward compatibility and CDK processes
3. **Update documentation** to reference this consolidated guide
4. **Consider creating** a single `.env.template` file in the future if .env files are allowed
